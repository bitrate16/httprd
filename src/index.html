<html>
	<head>
		<title>HTTPRD</title>
		<meta charset="UTF-8">
		<style>
			canvas {
				width: 100%;
				height: 100%;
			}

			* {
				font-family: monospace;
				font-weight: bold;
			}

			html, body {
				width: 100%;
				height: 100%;
				padding: 0;
				margin: 0;
			}

			#dialog {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 900;
				top: 0;
				left: 0;

				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
			}

			#dialog > #shadow {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 910;
				top: 0;
				left: 0;
				background-color: #0007;
			}

			#dialog > #content {
				z-index: 920;
				padding: 1rem;
				background-color: #fff;
			}

			#dialog > #content > #title {
				font-size: 1.5rem;
				margin-bottom: 0.5rem;
			}

			#dialog > #content > #form {
				width: 100%;
			}

			div.input-field {
				display: flex;
				flex-direction: row;
				flex-wrap: nowrap;
				justify-content: space-between;
				width: calc(100% - 1rem);
				border: thin solid #aaf;
				padding: 0.5rem;
				margin-bottom: 0.5rem;
			}

			div.input-field > label {
				padding: 0.25rem;
			}

			div.input-field > div {
				display: flex;
				flex-direction: row;
				flex-wrap: nowrap;
				gap: 0.5rem;
			}

			div.input-field > div > input {
				background-color: #eee;
				border: thin solid #aaf;
				box-sizing: border-box;
				padding: 0.25rem;
			}

			div.input-field > div > input:hover {
				box-shadow: #77f 0px 0px 0px 0.1rem;
				opacity: 0.75;
			}

			div.input-field > div > input:active {
				border: thin solid #77f;
			}

			div.input-field > div > input[type="button"]:active {
				background-color: #77e;
			}

			#config {
				position: absolute;
				width: 1rem;
				height: 1rem;
				bottom: 1rem;
				right: 1rem;
				overflow: hidden;
				font-size: 1rem;
				cursor: pointer;
				user-select: none;
			}
		</style>
	</head>
	<body>
		<canvas id="display">
		</canvas>
		<div id="dialog" style="display:none;">
			<div id="content">
				<div id="title">
					Config
				</div>
				<div id="form">
				</div>
			</div>
			<div id="shadow" onclick="hideConfigDialog();"></div>
		</div>
		<div id="config" onclick="showConfigDialog();">âš™</div>
		<script type="text/javascript" async>

			const INPUT_EVENT_MOUSE_MOVE   = 0;
			const INPUT_EVENT_MOUSE_DOWN   = 1;
			const INPUT_EVENT_MOUSE_UP     = 2;
			const INPUT_EVENT_MOUSE_SCROLL = 3;

			function getCookie(name) {
				const value = `; ${document.cookie}`;
				const parts = value.split(`; ${name}=`);
				if (parts.length === 2)
					return parts.pop().split(';').shift();
				return null;
			}

			function setCookie(cname, cvalue) {
				const d = new Date();
				d.setTime(d.getTime() + (36500 * 24 * 60 * 60 * 1000));
				let expires = "expires="+ d.toUTCString();
				document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.pegasko.art";
			}

			function showToast(text, duration, appearDuration) {
				console.error(text)
				if (duration <= 0)
					throw new Error('Invalid value for duration');

				if (appearDuration <= 0)
					throw new Error('Invalid value for appearDuration');

				// Wrapper for centering
				var element = document.createElement('div');
				element.style.cssText = `
					position: fixed;
					transition: opacity ${ appearDuration }s, bottom ${ appearDuration }s ease-in-out;
					pointer-events: none;
					user-select: none;
					left: 1rem;
					opacity: 0;
					bottom: -3rem;
				`;

				var inner = document.createElement('div');
				inner.style.cssText = `
					pointer-events: none;
					user-select: none;
					font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
					font-size: 1rem;
					padding: 0.5rem;
					line-height: calc(1rem - 0.2rem);
					box-sizing: border-box;
					background-color: white;
					border: 0.1rem solid #77f;
					color: #77f;
					font-weight: bold;
					text-align: center;
					margin-left: auto;
					margin-right: auto;
				`;
				inner.textContent = text;

				element.appendChild(inner);
				document.body.appendChild(element);

				// Wait & show
				getComputedStyle(element).opacity;
				element.style.bottom = '1rem';
				element.style.opacity = '1';

				// Appear + visible delay
				setTimeout(function() {
					// Make transparent and hide
					element.style.bottom = '-3rem';
					element.style.opacity = '0';

					setTimeout(function() {
						// Dispose
						document.body.removeChild(element);
					}, appearDuration * 1000);
				}, appearDuration * 1000 + duration * 1000);
			}

			function saget(url) {
				return new Promise((resolve, reject) => {
					fetch(url)
					.then((response) => {
						if (response.status != 200) {
							reject({
								'status': 'error',
								'message': response.statusText
							});
							return;
						} else
							return response.json();
					})
					.then((data) => {
						if (data === undefined)
							reject({ status: 'error', message: 'empty response' });
						else if (data['status'] != 'result')
							reject(data);
						else
							resolve(data);
					})
					.catch((error) => {
						reject(error);
					})
				});
			};

			function htmlToElement(html) {
				var template = document.createElement('template');
				html = html.trim();
				template.innerHTML = html;
				return template.content.firstChild;
			};

			function fetchConfig() {
				return new Promise((resolve, reject) => {
					window.config = window.config ?? {};
					if (!(window.config && window.config.password)) {
						if (getCookie('password') === null) {
							setCookie('password', '');
							window.config['password'] = '';
						} else {
							window.config['password'] = getCookie('password');
						}
					}

					saget(`/config?password=${ encodeURIComponent(window.config['password']) }&action=get`)
					.then(async (data) => {
						resolve(window.config = data.config);
					})
					.catch((error) => {
						console.error(error);
						showToast(error.message, 1, 1);
						reject(error);
					});
				});
			}

			function hideConfigDialog() {
				document.getElementById('dialog').style.display='none';
				startFetchLoop();
			}

			async function showConfigDialog() {
				stopFetchLoop();

				await fetchConfig()
				.then(() => {})
				.catch(() => {});

				document.getElementById('dialog').style.display=null;
				var form = document.getElementById('form');
				form.innerHTML = '';

				for (const [key, value] of Object.entries(window.config)) {
					var element = htmlToElement(`
					<div class="input-field">
						<label>${ key }</label>
						<div>
							<input type="text" value="${ value }" id="input-${ key }">
							<input type="button" value="set" id="submit-${ key }">
						</div>
					</div>`);

					form.appendChild(element);
					document.querySelector(`#submit-${ key }`).addEventListener('click', function() {
						let newValue = document.querySelector(`#input-${ key }`).value.trim();

						if (key === 'quality') {
							if (!(/^\d+$/.test(newValue))) {
								showToast('quality must be in range [1, 100]', 1, 1);
								return;
							}
							newValue = parseInt(newValue);
							if (newValue < 1 || newValue > 100) {
								showToast('quality must be in range [1, 100]', 1, 1);
								return;
							}
						} else if (key === 'fps') {
							if (!(/^\d+$/.test(newValue))) {
								showToast('fps must be in range [1, 60]', 1, 1);
								return;
							}
							newValue = parseInt(newValue);
							if (newValue < 1 || newValue > 100) {
								showToast('fps must be in range [1, 60]', 1, 1);
								return;
							}
						} else if (key === 'width') {
							if (!(/^\d+$/.test(newValue))) {
								showToast('width must be pair in range [16, inf]', 1, 1);
								return;
							}
							newValue = parseInt(newValue);
							if (newValue < 16) {
								showToast('width must be in range [16, inf]', 1, 1);
								return;
							}
						} else if (key === 'height') {
							if (!(/^\d+$/.test(newValue))) {
								showToast('height must be pair in range [16, inf]', 1, 1);
								return;
							}
							newValue = parseInt(newValue);
							if (newValue < 16) {
								showToast('height must be in range [16, inf]', 1, 1);
								return;
							}
						}

						var old_password = window.config['password'];
						if (key === 'password') {
							setCookie('password', newValue);
							window.config['password'] = newValue;
						}

						saget(`/config?password=${ encodeURIComponent(old_password) }&action=set&key=${ key }&value=${ newValue }`)
						.then((data2) => {
							window.config[key] = data2.value;
							document.querySelector(`#input-${ key }`).value = data2.value;

							if (key === 'password') {
								hideConfigDialog();
							}
						})
						.catch((error) => {
							console.error(error);
							showToast(error.message, 1, 1);

							if (key === 'password') {
								hideConfigDialog();
							}
						});
					});
				}
			}

			function stopFetchLoop() {
				window.fetchLoopRunning = window.fetchLoopRunning ?? false;
				if (window.fetchLoopRunning) {
					window.fetchLoopRunning = false;
					window.remoteSocketTs = 0;
				}
			}

			function startFetchLoop() {
				// Clear old
				window.fetchLoopRunning = window.fetchLoopRunning ?? false;
				stopFetchLoop();

				// Is started at least one loop
				window.fetchLoopRunning = true;

				// Delay steps
				var frameDelay = 1000.0 / (window.config.fps ?? 1);
				var inputDelay = 1000.0 / (window.config.ips ?? 1);

				// Last mouse vent time
				var lastMouseTs = -1;

				var connectToRemote = function() {

					// Current socket timestamp, prevent stacking
					var remoteSocketTs = window.remoteSocketTs = Date.now();

					// Create socket for frames stream
					var remoteSocket = null;
					var frames_received = 0;

					var closeConnection = function() {
						if (remoteSocket !== null) {
							try { remoteSocket.close(); } catch {}
							remoteSocket = null;

							// Info
							showToast('Connection closed', 1, 1);

							// Restart
							if (window.fetchLoopRunning && remoteSocketTs === window.remoteSocketTs)
								connectToRemote();
						}
					};

					// Receive frames from server
					var frame_worker = function(msg) {
						var url = URL.createObjectURL(msg.data);
						var frame = new Image();
						frame.onload = function() {
							URL.revokeObjectURL(url);

							window.canvasContext.drawImage(
								frame,
								canvas.width / 2 - frame.width / 2,
								canvas.height / 2 - frame.height / 2
							);

							// Update remote viewbox
							window.viewbox.width = frame.width;
							window.viewbox.height = frame.height;

							// Send ACK
							try {
								remoteSocket.send('FA');
							} catch {}

							++frames_received;
						};
						frame.src = url;

						// Close connection on stop / disconnect
						if (remoteSocketTs !== window.remoteSocketTs) {
							closeConnection();
						}
					};

					// Send input state & check open status
					var input_worker = function(msg) {

						// Close on socket update
						if (remoteSocketTs !== window.remoteSocketTs) {
							closeConnection();
							return;
						} else if (remoteSocket === null) {
							return;
						}

						// Update viewport
						if (canvas.width != window.innerWidth || canvas.height != window.innerHeight) {
							canvas.width = window.innerWidth;
							canvas.height = window.innerHeight;

							// Update props for view
							window.lineHeight = window.getComputedStyle(document.body).lineHeight;
							window.pageHeight = window.clientHeight;

							saget(`/config?password=${ encodeURIComponent(window.config['password']) }&action=set&key=width&value=${ canvas.width }`)
							.then((data) => {})
							.catch((error) => {
								showToast(error.message, 1, 1);
							});

							saget(`/config?password=${ encodeURIComponent(window.config['password']) }&action=set&key=height&value=${ canvas.height }`)
							.then((data) => {})
							.catch((error) => {
								showToast(error.message, 1, 1);
							});
						}

						// Send mouse location
						if (window.inputEvents.length !== 0 && frames_received !== 0) {
							try {
								let events = window.inputEvents;
								window.inputEvents = [];
								remoteSocket.send(JSON.stringify(events));
							} catch {}
						}

						setTimeout(input_worker, inputDelay);
					};

					// Receive only
					console.info('connect to', `${ window.location.protocol === 'https:' ? 'wss' : 'ws' }://${ window.location.host }/connect_ws`)
					remoteSocket = new WebSocket(`${ window.location.protocol === 'https:' ? 'wss' : 'ws' }://${ window.location.host }/connect_ws?password=${ encodeURIComponent(window.config['password']) }`);
					remoteSocket.onmessage = frame_worker;
					remoteSocket.onopen = input_worker;
					remoteSocket.onclose = closeConnection;
				};

				connectToRemote();
			}

			function startInputLoop() {

				// Input handler
				var lastMouseMoveTs = Date.now();
				var mouseMove = function(event) {
					// Fire only inside viewbox & with throttling to ips x 2
					if (window.viewbox.width === 0 || window.viewbox.height === 0 || Date.now() - lastMouseMoveTs <= 1000.0 / (window.config.ips ?? 1) || window.inputEvents.length > window.config.ips * 2)
						return;

					let rectX = (window.canvas.clientWidth / 2) - (window.viewbox.width / 2);
					let rectY = (window.canvas.clientHeight / 2) - (window.viewbox.height / 2);

					if (
						event.pageX >= rectX && event.pageX <= rectX + window.viewbox.width &&
						event.pageY >= rectY && event.pageY <= rectY + window.viewbox.height
						) {
							window.inputEvents.push([
								INPUT_EVENT_MOUSE_MOVE,
								event.pageX - rectX,
								event.pageY - rectY
							]);
						lastMouseMoveTs = Date.now();
					}
				};

				// Update props for view
				window.lineHeight = window.getComputedStyle(document.body).lineHeight;
				window.pageHeight = window.clientHeight;

				// Input handler
				var lastMouseScrollTs = Date.now();
				var mouseScroll = function(event) {
					// Fire only inside viewbox & with throttling to ips x 2
					if (window.viewbox.width === 0 || window.viewbox.height === 0 || Date.now() - lastMouseScrollTs <= 1000.0 / (window.config.ips ?? 1) || window.inputEvents.length > window.config.ips * 2)
						return;

					let rectX = (window.canvas.clientWidth / 2) - (window.viewbox.width / 2);
					let rectY = (window.canvas.clientHeight / 2) - (window.viewbox.height / 2);

					if (
						event.pageX >= rectX && event.pageX <= rectX + window.viewbox.width &&
						event.pageY >= rectY && event.pageY <= rectY + window.viewbox.height
						) {
							// Add event
							window.inputEvents.push([
								INPUT_EVENT_MOUSE_SCROLL,
								event.pageX - rectX,
								event.pageY - rectY,
								-event.deltaY
							]);
						lastMouseScrollTs = Date.now();
					}
				};

				// Input handler
				var mouseDown = function(event) {
					// Stop event
					event.preventDefault();
					event.stopPropagation();

					// Check
					if (window.viewbox.width === 0 || window.viewbox.height === 0)
						return;

					let rectX = (window.canvas.clientWidth / 2) - (window.viewbox.width / 2);
					let rectY = (window.canvas.clientHeight / 2) - (window.viewbox.height / 2);

					if (
						event.pageX >= rectX && event.pageX <= rectX + window.viewbox.width &&
						event.pageY >= rectY && event.pageY <= rectY + window.viewbox.height
					) {
						window.inputEvents.push([
							INPUT_EVENT_MOUSE_DOWN,
							event.pageX - rectX,
							event.pageY - rectY,
							event.button,
						]);
					}
				};

				// Input handler
				var mouseUp = function(event) {
					// Stop event
					event.preventDefault();
					event.stopPropagation();

					// Check
					if (window.viewbox.width === 0 || window.viewbox.height === 0)
						return;

					let rectX = (window.canvas.clientWidth / 2) - (window.viewbox.width / 2);
					let rectY = (window.canvas.clientHeight / 2) - (window.viewbox.height / 2);

					window.inputEvents.push([
						INPUT_EVENT_MOUSE_UP,
						event.pageX - rectX,
						event.pageY - rectY,
						event.button,
					]);
				};

				// Register listeners
				window.canvas.addEventListener('mousemove', mouseMove);
				window.canvas.addEventListener('wheel', mouseScroll);
				window.canvas.addEventListener('mousedown', mouseDown);
				window.canvas.addEventListener('mouseup', mouseUp);
				window.canvas.addEventListener('contextmenu', function(event) { event.preventDefault(); event.stopPropagation();  false; });
			}

			(async function() {
				window.canvas = document.getElementById('display');
				window.canvasContext = window.canvas.getContext('2d');

				// Input events buffer
				window.inputEvents = [];

				// Viewbox size
				window.viewbox = { width: 0, height: 0 };

				// Load config
				await fetchConfig();

				// Start loops
				startFetchLoop();
				startInputLoop();
			}) ();
		</script>
	</body>
</html>
